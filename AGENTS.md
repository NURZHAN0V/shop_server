# Правила для агента (shop_backend)

## Технический стек

- **Runtime**: Node.js, ESM
- **Язык**: TypeScript 5.8, строгий режим
- **Фреймворк**: Express 5
- **БД и ORM**: Prisma 7, SQLite (клиент в `prisma/generated/client`)
- **Валидация**: Zod 4
- **Аутентификация**: JWT (express-jwt), bcryptjs
- **Логирование**: Pino
- **Безопасность и инфра**: Helmet, CORS, compression, express-rate-limit

При генерации кода учитывать этот стек и существующие модули (`src/config`, `src/lib`, `src/middleware`, `src/routes`, `src/schemas`).

---

## Типы: запрет any

Тип `any` не использовать. Вместо него:

- для неизвестных данных — `unknown`, затем сужение типа или проверки;
- для аргументов и результатов — явные интерфейсы или типы из Prisma/Zod;
- для ошибок в `catch` — `unknown`, при необходимости проверять через `instanceof` или type guard.

В `tsconfig.json` держать строгие проверки (`strict: true`), не ослаблять.

---

## Комментарии к функциям — только на русском

У каждой экспортируемой и каждой нетривиальной функции должен быть комментарий на русском: что делает функция, при необходимости — параметры и возвращаемое значение. Комментарии к маршрутам и сложным блокам тоже на русском.

---

## Краткие конвенции

- **Роуты**: логика в обработчиках, валидация через Zod-схемы и middleware `validate`, типы для тела запроса из схем (например `CreateUserInput`).
- **Prisma**: использовать сгенерированный клиент из `prisma/generated/client`, не дублировать типы моделей вручную, где можно использовать `Prisma.UserCreateInput` и т.п.
- **Ошибки**: централизованная обработка в `errorHandler`, логировать через `logger` из `src/lib/logger`.
- **Конфиг**: переменные окружения через `src/config/env.ts`.
- **Стиль**: соблюдать существующий стиль (например, комментарии маршрутов в формате `// POST /api/auth/login — ...`).

При добавлении нового кода проверять: нет ли `any`, есть ли русские комментарии к функциям и соответствие стеку и структуре проекта.

---

## Аутентификация и авторизация

- **JWT**: в приложении используется express-jwt; публичные пути задаются через `unless` (например `/`, `/api/auth/login`, POST `/api/auth/register`). Секрет и опции (audience, issuer, expiresIn) берутся из `src/config/env`.
- **Выдача токена**: подпись только через `signAccessToken` из `src/lib/jwt`; в payload передавать как минимум `sub` (id пользователя), `email`, `role`.
- **Пароли**: хеширование и сравнение только через `src/lib/password` (`hashPassword`, `comparePassword`); не хранить и не отдавать пароль в открытом виде.
- **Роли**: маршруты только для администратора защищать middleware `requireAdmin` из `src/middleware/requireAdmin`; он ставится после express-jwt и проверяет `req.auth?.role === 'admin'`. В index админ-роутер монтируется с `requireAdmin` перед ним.

---

## Доступ к пользователю в обработчиках

После JWT в запросе доступно поле `req.auth` (тип расширяется через `(req as { auth?: { sub?: number; role?: string } }).auth`). `sub` — идентификатор пользователя, `role` — для проверки прав. Если маршрут требует авторизации и JWT уже проверен, достаточно читать `auth?.sub`; при необходимости дополнительно проверять роль.

---

## Валидация запросов и ответов

- **Вход**: схемы Zod в `src/schemas` со структурой `{ body?, params?, query? }`. Для маршрута использовать middleware `validate(schema)` из `src/middleware/validate`; после успешной валидации в `req` попадают типизированные body/params/query.
- **Типы**: типы для тела запроса и параметров брать из схем через `z.infer` (например `CreateUserInput` из схемы пользователя), не дублировать интерфейсы вручную.
- **Ответы**: при необходимости валидировать ответ через `validateResponse(schema)` из `src/middleware/validateResponse`.

---

## Обработка ошибок

- Централизованный обработчик — `errorHandler` из `src/middleware/errorHandler`: обрабатывает `UnauthorizedError` (401), `ZodError` (400), остальное — 500. В production в ответе не отдавать внутренние детали (stack, сообщения реализации).
- Все ошибки и важные события логировать через `logger` из `src/lib/logger` (warn для валидации и 401, error для необработанных и серверных ошибок).

---

## Безопасность ответов

Перед отправкой пользовательских или сущностных данных в ответе не включать служебные поля (в первую очередь `password`). Использовать деструктуризацию и исключать такие поля из объекта перед `res.json`.

---

## Структура API и маршрутов

- Префиксы: `/api/auth` (логин, регистрация), `/api/users` (текущий пользователь, требует JWT), `/api/admin/users` (управление пользователями, требует JWT и роль admin через `requireAdmin`).
- Публичные без JWT: GET `/`, POST `/api/auth/login`, POST `/api/auth/register`. При добавлении новых публичных путей обновлять `unless` у express-jwt в `src/index.ts`.

---

## Prisma и база данных

- Клиент импортировать из `prisma/generated/client`; в приложении используется один экземпляр из `src/lib/prisma` (с адаптером better-sqlite3 по конфигу). Не создавать новый PrismaClient в роутах или сервисах.
- Идентификаторы из `req.params` при использовании в Prisma приводить к нужному типу через схемы Zod (например `z.coerce.number()`) или явное преобразование после валидации; не полагаться на строковый тип params без валидации.

---

## Запуск и завершение

Сервер слушает порт только при прямом запуске точки входа (не при импорте в тестах). При получении SIGTERM выполнять: закрытие HTTP-сервера, `prisma.$disconnect()`, затем `process.exit(0)`, чтобы корректно завершить соединения с БД.
